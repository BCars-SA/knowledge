services:
  ubuntu-test:
    image: ubuntu:latest
    container_name: ansible-vps-test
    hostname: ansible-test-host
    privileged: true
    tty: true
    stdin_open: true
    ports:
      - "2222:22"
    environment:
      - DEBIAN_FRONTEND=noninteractive
      - SSH_ADMIN_IPS=172.16.0.0/12,192.168.0.0/16
    volumes:
      - ./test-data:/mnt/test-data
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ssh-keys:/shared
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    command:
      - bash
      - -c
      - |
        apt-get update && 
        apt-get install -y openssh-server python3 python3-pip sudo systemd curl wget git &&
        systemctl enable ssh &&
        useradd -m -s /bin/bash -G sudo testuser &&
        echo 'testuser:testpass' | chpasswd &&
        mkdir -p /home/testuser/.ssh &&
        echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers &&
        service ssh start &&
        while [ ! -f /shared/authorized_keys ]; do sleep 2; done &&
        cp /shared/authorized_keys /home/testuser/.ssh/ &&
        chown -R testuser:testuser /home/testuser/.ssh &&
        chmod 700 /home/testuser/.ssh &&
        chmod 600 /home/testuser/.ssh/authorized_keys &&
        exec /sbin/init
    
  ansible-controller:
    image: willhallonline/ansible:latest
    container_name: ansible-controller
    working_dir: /ansible
    volumes:
      - .:/ansible
      - ssh-keys:/shared
    environment:
      - ANSIBLE_HOST_KEY_CHECKING=False
      - SSH_ADMIN_IPS=172.16.0.0/12,192.168.0.0/16
    depends_on:
      - ubuntu-test
    command:
      - sh
      - -c
      - |
        mkdir -p /root/.ssh &&
        ssh-keygen -t rsa -b 2048 -f /root/.ssh/id_rsa -N '' &&
        chmod 600 /root/.ssh/id_rsa &&
        chmod 644 /root/.ssh/id_rsa.pub &&
        cp /root/.ssh/id_rsa.pub /shared/authorized_keys &&
        sleep infinity

volumes:
  ssh-keys: